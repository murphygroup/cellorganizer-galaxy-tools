<tool id="model_training2" name="Train" version="0.0.3">
  <description> a generative model</description>
  <command>
    matlab -r "diary diary.txt;
    tic; 
    current_directory = pwd; 
    cellorganizer_directory = getenv('CELLORGANIZER'); 
    cd( cellorganizer_directory ); 
    setup(); 
    cd( current_directory );
    check_if_files_exist_on_disk_and_link_them('$dataset');
 
    selection_flag('$dimensionality','$nuc.nclasstype.nucleusclass','$nuc.nclasstype.nucleustype');
    selection_flag('$dimensionality','$optmmodel.mem.cclasstype.cellclass','$optmmodel.mem.cclasstype.celltype');
    selection_flag('$dimensionality','$optmmodel.mem.optpmodel.pro.pclasstype.proteinclass','$optmmodel.mem.optpmodel.pro.pclasstype.proteintype');
    selection_flag('$dimensionality','$optmmodel.mem.optcmodel.cyto.pclasstype.proteinclass','$optmmodel.mem.optpmodel.cyto.pclasstype.proteintype');

    documentation = struct();
    #for $field in $doc.documentation
      documentation = setfield( documentation, '${field.docname}', '${field.docvalues}' );
    #end for

    train_model('$dimensionality','$maskchannel','$dnachannel','$cellchannel','$proteinchannel','$cproteinchannel','$modelname','$modelid','$gen.downsamplex','$gen.downsampley','$gen.downsamplez','$nuc.nclasstype.nucleustype','$nuc.nucleusname','$nuc.nucleusclass','$nuc.nucleusid','$optmmodel.mem.cclasstype.celltype','$optmmodel.mem.cellname','$optmmodel.mem.cclasstype.cellclass','$optmmodel.mem.cellid','$optmmodel.mem.optpmodel.pro.pclasstype.proteintype','$optmmodel.mem.optpmodel.pro.proteinname','$optmmodel.mem.optpmodel.pro.pclasstype.proteinclass','$optmmodel.mem.optpmodel.pro.proteinid','$optmmodel.mem.optpmodel.pro.proteincytonuclearflag','$optmmodel.mem.optcmodel.cyto.cpclasstype.proteintype','$optmmodel.mem.optcmodel.cyto.proteinname','$optmmodel.mem.optcmodel.cyto.proteinclass','$optmmodel.mem.optcmodel.cyto.proteinid','$optmmodel.mem.optcmodel.cyto.proteincytonuclearflag','$documentation','$gen.verbose','$gen.debug');


    toc,
    diary off;
    diary model_information.txt;
    if exist( './model.mat' ); load( './model.mat' ); model2info( model ); end;
    diary off;
    exit;";
    
    bash $__tool_directory__/train_model_report.sh $output2.extra_files_path;
  </command>
  <inputs>
    <param name="dataset" type="data" label="Choose a data set for training" multiple="true" optional="false" />
    <param name="modelname" type="text" value="model" label="Provide a name for the model"/>
    <param name="modelid" type="text" value="default" label="Provide an (optional) id for the model"/>
    <param name="dimensionality" type="select" label="Dimensionality:">
      <option value="2D" selected="true">2D</option>
      <option value="3D">3D</option>
    </param>
    <param name="dnachannel" type="integer" value="1" label="Provide the dna channel number for the imageset"/>
    <section name="nuc" title="Nucleus Options" expanded="false">
      <param name="nucleusname" type="text" value="default" label="Provide an (optional) name for the nuclear model"/>
      <conditional name="nclasstype">
        <param name="nucleusclass" label="Choose a class for this model:" type="select">
          <option value="vesicle" selected="true">vesicle</option>
          <option value="nuclear_membrane">nuclear membrane</option>
          <option value="cell_membrane">cell membrane</option>
          <option value="framework">framework</option>
          <option value="network">network</option>
          <option value="protein_distribution">protein distribution</option>
          <option value="standardized_voxels">standardized voxels</option>
        </param>
        <when value="vesicle">
          <param name="nucleustype" label="Choose a model type:" type="select">
            <option value="gmm">gmm</option>
          </param>
         </when>
         <when value="nuclear_membrane">
          <param name="nucleustype" label="Choose a model type:" type="select">
             <option value="medial_axis">medial axis</option>
             <option value="cylindrical_surface">cylindrical surface</option>
          </param>
        </when>
         <when value="cell_membrane">
          <param name="nucleustype" label="Choose a model type:" type="select">
            <option value="ratio">ratio</option>
          </param>
        </when>
        <when value="framework">
          <param name="nucleustype" label="Choose a model type:" type="select">
            <option value="diffeomorphic">diffeomorphic</option>
          </param>
        </when>
        <when value="network">
          <param name="nucleustype" label="Choose a model type:" type="select">
            <option value="microtubule_growth">microtubule growth</option>
          </param>
        </when>
        <when value="protein_distribution">
          <param name="nucleustype" label="Choose a model type:" type="select">
            <option value="morphing">morphing</option>
          </param>
        </when>
        <when value="standardized_voxels">
          <param name="nucleustype" label="Choose a model type:" type="select">
            <option value="standardized_map_half-ellipsoid">standardized map half-ellipsoid</option>
          </param>
        </when>
      </conditional>
      <param name="nucleusid" type="text" value="default" label="Provide an (optional) id for the nuclear model"/>
    </section>

    <conditional name="optmmodel">
      <param name="optmmodel_selector" label="Would you like to model a Cell Membrane?" type="select">
        <option value="yes" selected="false"/>
        <option value="no" selected="true"/>
      </param>
      <when value="yes">
        <param name="maskchannel" type="integer" value="4" label="Provide the mask channel number for the imageset"/>
        <section name="mem" title="Cell Membrane Options" expanded="false">
          <param name="cellname" type="text" value="default" label="Provide an (optional) name for the cell model"/>
          <conditional name="cclasstype">
            <param name="cellclass" label="Choose a class for this model:" type="select">
              <option value="vesicle" selected="true">vesicle</option>
              <option value="nuclear_membrane">nuclear membrane</option>
              <option value="cell_membrane">cell membrane</option>
              <option value="framework">framework</option>
              <option value="network">network</option>
              <option value="protein_distribution">protein distribution</option>
              <option value="standardized_voxels">standardized voxels</option>
            </param>
            <when value="vesicle">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="gmm">gmm</option>
              </param>
            </when>
            <when value="nuclear_membrane">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="medial_axis">medial axis</option>
                <option value="cylindrical_surface">cylindrical surface</option>
              </param>
            </when>
            <when value="cell_membrane">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="ratio">ratio</option>
              </param>
            </when>
            <when value="framework">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="diffeomorphic">diffeomorphic</option>
              </param>
            </when>
            <when value="network">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="microtubule_growth">microtubule growth</option>
              </param>
            </when>
            <when value="protein_distribution">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="morphing">morphing</option>
              </param>
            </when>
            <when value="standardized_voxels">
              <param name="celltype" label="Choose a model type:" type="select">
                <option value="standardized_map_half-ellipsoid">standardized map half-ellipsoid</option>
              </param>
            </when>
          </conditional>
          <param name="cellid" type="text" value="default" label="Provide an (optional) id for the cell model"/>
        </section>
      
        <conditional name="optpmodel">
          <param name="optpromodel" label="Would you like to model an object?" type="select">
            <option value="yes" selected="false"/>
            <option value="no" selected="true"/>
          </param>
          <when value="yes">
            <param name="cellchannel" type="integer" value="2" label="Provide the cell channel number for the imageset"/>
            <section name="pro" title="Protein Options" expanded="false">
              <param name="proteinname" type="text" value="default" label="Provide an (optional) name for the protein model"/>
              <conditional name="pclasstype">
                <param name="proteinclass" label="Choose a class for this model:" type="select">
                  <option value="vesicle" selected="true">vesicle</option>
                  <option value="nuclear_membrane">nuclear membrane</option>
                  <option value="cell_membrane">cell membrane</option>
                  <option value="framework">framework</option>
                  <option value="network">network</option>
                  <option value="protein_distribution">protein distribution</option>
                  <option value="standardized_voxels">standardized voxels</option>
                </param>
                <when value="vesicle">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="gmm">gmm</option>
                  </param>
                </when>
                <when value="nuclear_membrane">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="medial_axis">medial axis</option>
                    <option value="cylindrical_surface">cylindrical surface</option>
                  </param>
                </when>
                <when value="cell_membrane">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="ratio">ratio</option>
                  </param>
                </when>
                <when value="framework">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="diffeomorphic">diffeomorphic</option>
                  </param>
                </when>
                <when value="network">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="microtubule_growth">microtubule growth</option>
                  </param>
                </when>
                <when value="protein_distribution">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="morphing">morphing</option>
                  </param>
                </when>
                <when value="standardized_voxels">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="standardized_map_half-ellipsoid">standardized map half-ellipsoid</option>
                  </param>
                </when>
              </conditional>
              <param name="proteinid" type="text" value="default" label="Provide an (optional) id for the protein model"/>
              <param name="proteincytonuclearflag" type="select" label="Select a protein location">
                <option value="cyto" selected="true">Cytoplasm</option>
                <option value="nuc">Nucleus</option>
                <option value="all">all</option>
              </param>
            </section>
          </when>
        </conditional>

        <conditional name="optcmodel">
          <param name="optcytomodel" label="Would you like to model a cytosekeleton?" type="select">
            <option value="yes" selected="false"/>
            <option value="no" selected="true"/>
          </param>
          <when value="yes">
            <param name="proteinchannel" type="integer" value="2" label="Provide the protein channel number for the imageset"/>
            <section name="cyto" title="Cytoskeleton Options" expanded="false">
              <param name="proteinname" type="text" value="default" label="Provide an (optional) name for the protein model"/>
              <conditional name="pclasstype">
                <param name="proteinclass" label="Choose a class for this model:" type="select">
                  <option value="vesicle" selected="true">vesicle</option>
                  <option value="nuclear_membrane">nuclear membrane</option>
                  <option value="cell_membrane">cell membrane</option>
                  <option value="framework">framework</option>
                  <option value="network">network</option>
                  <option value="protein_distribution">protein distribution</option>
                  <option value="standardized_voxels">standardized voxels</option>
                </param>
                <when value="vesicle">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="gmm">gmm</option>
                  </param>
                </when>
                <when value="nuclear_membrane">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="medial_axis">medial axis</option>
                    <option value="cylindrical_surface">cylindrical surface</option>
                  </param>
                </when>
                <when value="cell_membrane">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="ratio">ratio</option>
                  </param>
                </when>
                <when value="framework">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="diffeomorphic">diffeomorphic</option>
                  </param>
                </when>
                <when value="network">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="microtubule_growth">microtubule growth</option>
                  </param>
                </when>
                <when value="protein_distribution">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="morphing">morphing</option>
                  </param>
                </when>
                <when value="standardized_voxels">
                  <param name="proteintype" label="Choose a model type:" type="select">
                    <option value="standardized_map_half-ellipsoid">standardized map half-ellipsoid</option>
                  </param>
                </when>
              </conditional>
              <param name="proteinid" type="text" value="default" label="Provide an (optional) id for the protein model"/>
              <param name="proteincytonuclearflag" type="select" label="Select a protein location">
                <option value="cyto" selected="true">Cytoplasm</option>
                <option value="nuc">Nucleus</option>
                <option value="all">all</option>
              </param>
            </section>
          </when>
        </conditional>
      </when>
    </conditional>


    <section name="gen" title="Advanced" expanded="false">
      <param name="downsamplex" type="select" label="Select a downsampling factor in the x dimension, larger values return a possible more coarse model">
        <option value="5" selected="true">5</option>
        <option value="2">2</option>
        <option value="1">1</option>
      </param>
      <param name="downsampley" type="select" label="Select a downsampling factor in the y direction, larger values return a possible more coarse model">
        <option value="5" selected="true">5</option>
        <option value="2">2</option>
        <option value="1">1</option>
      </param>
      <param name="downsamplez" type="select" label="Select a downsampling factor in the z direction, larger values return a possible more coarse model">
        <option value="5">5</option>
        <option value="2">2</option>
        <option value="1" selected="true">1</option>
      </param>
      <param name="verbose" type="boolean" label="Print all information provided during training?" selected="true">
      </param>
      <param name="debug" type="boolean" label="Save intermediate results?" selected="false">
      </param>
    </section>
    
    <section name="doc" title="Documentation" expanded="false">
      <repeat name="documentation" title="Documentation">
        <param name="docname" type="text" label="Name"> </param>
        <param name="docvalues" type="text" label="Values"></param>
      </repeat>
    </section>

  </inputs>
  <outputs>
    <data format="mat" name="output1" from_work_dir="model.mat"/>
    <data format="html" name="output2" from_work_dir="report.html"/>
  </outputs>

  <help>

  **Description**

  Trains a generative model from a collection of OME.TIFF files.

  -----

  **Input**

  A dataset of OME.TIFF files, and a combination of options selections.

  -----

  **Output**

  A generative model.

  </help>
</tool>
